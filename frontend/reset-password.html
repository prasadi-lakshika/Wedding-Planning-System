<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password - Wedding Planning System</title>
  <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
  <header>
    <div class="navbar">
      <nav id="mainNav">
        <a href="index.html" class="nav-link">Home</a>
      </nav>
    </div>
  </header>
  
  <main class="main-content">
    <div style="max-width: 500px; margin: 50px auto; padding: 30px; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Reset Your Password</h2>
      
      <!-- Token validation message -->
      <div id="tokenStatus" style="display: none; padding: 15px; margin-bottom: 20px; border-radius: 5px;"></div>
      
      <!-- Reset password form (shown when token is valid) -->
      <form id="resetPasswordForm" style="display: none;">
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="newPassword" style="display: block; margin-bottom: 8px; font-weight: bold;">New Password</label>
          <input 
            type="password" 
            id="newPassword" 
            placeholder="Enter new password" 
            required 
            minlength="6"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
          >
          <small style="color: #666; font-size: 0.9em;">Password must be at least 6 characters long</small>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="confirmPassword" style="display: block; margin-bottom: 8px; font-weight: bold;">Confirm Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            placeholder="Confirm new password" 
            required 
            minlength="6"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;"
          >
        </div>
        
        <button 
          type="submit" 
          class="login-btn" 
          style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px;"
        >
          Reset Password
        </button>
        
        <div id="resetPasswordMsg" style="color: red; font-size: 0.98em; margin-bottom: 10px; text-align: center;"></div>
        <div id="resetPasswordSuccess" style="color: green; font-size: 0.98em; margin-bottom: 10px; text-align: center; display: none;"></div>
      </form>
      
      <!-- Loading indicator -->
      <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none;">
        <p>Validating reset token...</p>
      </div>
      
      <!-- Back to login link -->
      <p style="text-align: center; margin-top: 20px;">
        <a href="index.html" style="color: #d4af37; text-decoration: none;">Back to Login</a>
      </p>
    </div>
  </main>
  
  <footer>&copy; 2025 Wedding Planning System</footer>
  
  <script>
    // Get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    const tokenStatus = document.getElementById('tokenStatus');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    // Validate token on page load
    if (token) {
      loadingIndicator.style.display = 'block';
      
      // Verify token
      fetch(`http://localhost:5000/auth/verify-reset-token?token=${encodeURIComponent(token)}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        loadingIndicator.style.display = 'none';
        
        if (data.valid) {
          // Token is valid, show form
          resetPasswordForm.style.display = 'block';
        } else {
          // Token is invalid or expired
          tokenStatus.style.display = 'block';
          tokenStatus.style.backgroundColor = '#f8d7da';
          tokenStatus.style.color = '#721c24';
          tokenStatus.style.border = '1px solid #f5c6cb';
          tokenStatus.innerHTML = `
            <strong>Invalid or Expired Token</strong><br>
            ${data.message || 'This password reset link is invalid or has expired. Please request a new password reset link.'}
          `;
        }
      })
      .catch(error => {
        console.error('Token verification error:', error);
        loadingIndicator.style.display = 'none';
        tokenStatus.style.display = 'block';
        tokenStatus.style.backgroundColor = '#f8d7da';
        tokenStatus.style.color = '#721c24';
        tokenStatus.style.border = '1px solid #f5c6cb';
        tokenStatus.innerHTML = '<strong>Error</strong><br>Unable to verify reset token. Please try again or request a new reset link.';
      });
    } else {
      // No token in URL
      loadingIndicator.style.display = 'none';
      tokenStatus.style.display = 'block';
      tokenStatus.style.backgroundColor = '#f8d7da';
      tokenStatus.style.color = '#721c24';
      tokenStatus.style.border = '1px solid #f5c6cb';
      tokenStatus.innerHTML = '<strong>Missing Token</strong><br>No reset token found. Please use the link from your email.';
    }
    
    // Handle reset password form submission
    if (document.getElementById('resetPasswordForm')) {
      document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const msgDiv = document.getElementById('resetPasswordMsg');
        const successDiv = document.getElementById('resetPasswordSuccess');
        const submitBtn = this.querySelector('button[type="submit"]');
        
        // Clear previous messages
        if (msgDiv) {
          msgDiv.textContent = '';
        }
        if (successDiv) {
          successDiv.style.display = 'none';
          successDiv.textContent = '';
        }
        
        // Validation
        if (!newPassword || !confirmPassword) {
          if (msgDiv) {
            msgDiv.textContent = 'Please fill in all fields.';
          }
          return;
        }
        
        if (newPassword.length < 6) {
          if (msgDiv) {
            msgDiv.textContent = 'Password must be at least 6 characters long.';
          }
          return;
        }
        
        if (newPassword !== confirmPassword) {
          if (msgDiv) {
            msgDiv.textContent = 'Passwords do not match.';
          }
          return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Resetting Password...';
        
        // Make API call to reset password
        fetch('http://localhost:5000/auth/reset-password', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: token,
            new_password: newPassword,
            confirm_password: confirmPassword
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            if (msgDiv) {
              msgDiv.textContent = data.error;
            }
          } else {
            // Show success message
            resetPasswordForm.style.display = 'none';
            if (successDiv) {
              successDiv.style.display = 'block';
              successDiv.textContent = data.message || 'Password reset successful! Redirecting to login...';
            }
            
            // Redirect to login after 3 seconds
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 3000);
          }
        })
        .catch(error => {
          console.error('Reset password error:', error);
          if (msgDiv) {
            msgDiv.textContent = 'Network error. Please check your connection and try again.';
          }
        })
        .finally(() => {
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.textContent = 'Reset Password';
        });
      });
    }
  </script>
</body>
</html>

